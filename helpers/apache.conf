<VirtualHost *:80>
    ServerName ${DOMAIN}

    # Comment to prevent HTTP to HTTPS redirect
    Redirect permanent / https://${DOMAIN}

    ErrorLog /var/log/apache2/${NAME}-error.log
    CustomLog /var/log/apache2/${NAME}-access.log combined

    RewriteEngine on
    RewriteCond %{SERVER_NAME} =${DOMAIN}
    RewriteRule ^ https://%{SERVER_NAME}%{REQUEST_URI} [END,NE,R=permanent]
</VirtualHost>

<VirtualHost *:443>
    ServerName ${DOMAIN}

    SSLEngine on
    SSLCertificateFile "/etc/letsencrypt/live/${DOMAIN}/fullchain.pem"
    SSLCertificateKeyFile "/etc/letsencrypt/live/${DOMAIN}/privkey.pem"
    
    RewriteEngine on
    RewriteCond %{HTTP:Upgrade} websocket [NC]
    RewriteCond %{HTTP:Connection} upgrade [NC]
    RewriteRule ^/?(.*) "ws://localhost:${PORT}/$1" [P,L]

    ProxyRequests On
    ProxyPass / http://localhost:${PORT}/
    ProxyPassReverse / http://localhost:${PORT}/
</VirtualHost>